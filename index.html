<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #loading { display: none; }
        .card { max-width: 600px; margin: 20px auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Agendamento de Laboratório</h4>
            </div>
            <div class="card-body">
                <form id="formAgendamento">
                    <div class="mb-3">
                        <label class="form-label">Recurso</label>
                        <select id="recurso" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Computador i7">Computador i7</option>
                            <option value="Estação CAD">Estação CAD</option>
                        </select>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Data</label>
                            <input type="date" id="data" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hora Início</label>
                            <input type="time" id="horaInicio" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hora Fim</label>
                            <input type="time" id="horaFim" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <span id="loading" class="spinner-border spinner-border-sm"></span>
                            Agendar
                        </button>
                    </div>
                </form>
                
                <div id="resultado" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSg8x2m-6yi5oosd04riI53TeeR9qR8W8-8MneSwbh4f8untkRI38-1oMCIg2ICQvt7w/exec';
        
        document.getElementById('formAgendamento').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = e.target.querySelector('button');
            const loading = document.getElementById('loading');
            const resultadoDiv = document.getElementById('resultado');
            
            // Configuração do UI durante o processamento
            btn.disabled = true;
            loading.style.display = 'inline-block';
            resultadoDiv.innerHTML = '';
            
            try {
                // 1. Preparar dados
                const dados = {
                    recurso: document.getElementById('recurso').value,
                    usuario: 'Usuário Teste', // Modifique conforme necessário
                    email: 'teste@exemplo.com', // Modifique conforme necessário
                    inicio: `${document.getElementById('data').value}T${document.getElementById('horaInicio').value}:00-03:00`,
                    fim: `${document.getElementById('data').value}T${document.getElementById('horaFim').value}:00-03:00`
                };
                
                // 2. Primeiro faz a requisição OPTIONS (CORS pré-flight)
                await fetch(`${SCRIPT_URL}?options`, { method: 'OPTIONS' });
                
                // 3. Faz a requisição POST principal
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const resultado = await response.json();
                
                if (!resultado.success) {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }
                
                // 4. Exibir mensagem de sucesso
                resultadoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Agendamento realizado!</h5>
                        <p>${resultado.message}</p>
                        <a href="${resultado.link}" target="_blank" class="btn btn-sm btn-success">
                            Ver no Google Agenda
                        </a>
                    </div>
                `;
                
                // 5. Limpar formulário
                e.target.reset();
                
            } catch (error) {
                // 6. Exibir mensagem de erro
                resultadoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Erro no agendamento</h5>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('Erro:', error);
            } finally {
                // 7. Restaurar UI
                btn.disabled = false;
                loading.style.display = 'none';
            }
        });
        
        // Configurar data mínima como hoje
        document.getElementById('data').min = new Date().toISOString().split('T')[0];
    </script>
</body>
</html>